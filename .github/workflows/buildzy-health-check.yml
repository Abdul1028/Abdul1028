name: Spring Infra Daily Health Check

on:
  schedule:
    - cron: '30 0 * * *'    # 06:00 IST
    - cron: '30 16 * * *'   # 22:00 IST
  workflow_dispatch:

jobs:
  ping-and-notify:
    runs-on: ubuntu-latest

    steps:

      # === API HEALTH CHECK ===
      - name: Check API Health
        id: api_health
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/api.json https://api.wareality.tech/actuator/health)
          BODY=$(cat /tmp/api.json)
          STATUS=$(echo "$BODY" | jq -r '.status // "UNKNOWN"')

          if [ "$STATUS" = "UP" ] && [ "$RESPONSE" -eq 200 ]; then
            SIGNAL="ðŸŸ¢"
          else
            SIGNAL="ðŸ”´"
          fi

          echo "api_status=$STATUS" >> $GITHUB_OUTPUT
          echo "api_code=$RESPONSE" >> $GITHUB_OUTPUT
          echo "api_signal=$SIGNAL" >> $GITHUB_OUTPUT

      # === LOG SERVICE HEALTH CHECK ===
      - name: Check Log Service
        id: log_health
        run: |
          RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/log.json https://kafka-log-service-4ebd58d6138e.herokuapp.com/actuator/health)
          BODY=$(cat /tmp/log.json)
          STATUS=$(echo "$BODY" | jq -r '.status // "UNKNOWN"')

          if [ "$STATUS" = "UP" ] && [ "$RESPONSE" -eq 200 ]; then
            SIGNAL="ðŸŸ¢"
          else
            SIGNAL="ðŸ”´"
          fi

          echo "log_status=$STATUS" >> $GITHUB_OUTPUT
          echo "log_code=$RESPONSE" >> $GITHUB_OUTPUT
          echo "log_signal=$SIGNAL" >> $GITHUB_OUTPUT

      # === S3 PROXY RESOLUTION CHECK ===
      - name: Check S3 Proxy (supply)
        id: proxy_health
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://supply.wareality.tech)
          if [ "$RESPONSE" -eq 200 ] || [ "$RESPONSE" -eq 304 ]; then
            STATUS="UP"
            SIGNAL="ðŸŸ¢"
          else
            STATUS="DOWN"
            SIGNAL="ðŸ”´"
          fi

          echo "proxy_status=$STATUS" >> $GITHUB_OUTPUT
          echo "proxy_code=$RESPONSE" >> $GITHUB_OUTPUT
          echo "proxy_signal=$SIGNAL" >> $GITHUB_OUTPUT

      # === SLACK NOTIFICATION ===
      - name: Notify Slack
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          payload=$(cat <<EOF
          {
            "text": "ðŸ“¡ *Infra Health Report*\n*API:* ${{ steps.api_health.outputs.api_signal }}  ${{ steps.api_health.outputs.api_status }} (HTTP ${{ steps.api_health.outputs.api_code }})\n*Logs:* ${{ steps.log_health.outputs.log_signal }}  ${{ steps.log_health.outputs.log_status }} (HTTP ${{ steps.log_health.outputs.log_code }})\n*S3 Proxy (supply):* ${{ steps.proxy_health.outputs.proxy_signal }}  ${{ steps.proxy_health.outputs.proxy_status }} (HTTP ${{ steps.proxy_health.outputs.proxy_code }})\nâ° Time: $(date -u +'%Y-%m-%d %H:%M UTC')"
          }
          EOF
          )
          curl -X POST -H "Content-type: application/json" --data "$payload" "$SLACK_WEBHOOK_URL"
